<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Real-time Test</title>
    <script src="/socket.io/socket.io.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        #log { border: 1px solid #ccc; height: 400px; overflow-y: auto; padding: 10px; background: #f9f9f9; }
        button { margin: 5px; padding: 10px; }
        .connected { color: green; }
        .disconnected { color: red; }
    </style>
</head>
<body>
    <h1>Real-time Socket.IO Test</h1>
    <div>
        Status: <span id="status" class="disconnected">Disconnected</span><br>
        File ID: <span id="fileId">06b23d22-416f-4460-8d0b-3c2096783e04</span><br>
        Active Users: <span id="activeUsers">0</span>
    </div>
    
    <div>
        <button onclick="testFileUpdate()">Test File Update Event</button>
        <button onclick="clearLog()">Clear Log</button>
    </div>
    
    <h3>Event Log:</h3>
    <div id="log"></div>
    
    <script>
        const fileId = '06b23d22-416f-4460-8d0b-3c2096783e04';
        let activeUserCount = 0;
        
        const socket = io({
            auth: {
                sessionId: 'test-session-' + Date.now()
            }
        });
        
        const statusEl = document.getElementById('status');
        const logEl = document.getElementById('log');
        const activeUsersEl = document.getElementById('activeUsers');
        
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const div = document.createElement('div');
            div.innerHTML = `<strong>${timestamp}</strong> [${type.toUpperCase()}] ${message}`;
            div.style.color = type === 'error' ? 'red' : type === 'success' ? 'green' : 'black';
            logEl.appendChild(div);
            logEl.scrollTop = logEl.scrollHeight;
        }
        
        function clearLog() {
            logEl.innerHTML = '';
        }
        
        socket.on('connect', () => {
            statusEl.textContent = 'Connected: ' + socket.id;
            statusEl.className = 'connected';
            log('Connected to socket server with ID: ' + socket.id, 'success');
            
            // Join file room
            socket.emit('join-file', fileId);
            log('Sent join-file event for: ' + fileId);
        });
        
        socket.on('disconnect', () => {
            statusEl.textContent = 'Disconnected';
            statusEl.className = 'disconnected';
            log('Disconnected from socket server', 'error');
        });
        
        socket.on('active-users', (data) => {
            log('Received active-users: ' + JSON.stringify(data));
            if (data.fileId === fileId) {
                activeUserCount = data.users.length;
                activeUsersEl.textContent = activeUserCount;
            }
        });
        
        socket.on('user-joined', (data) => {
            log('User joined: ' + data.username + ' at ' + data.timestamp);
            activeUserCount++;
            activeUsersEl.textContent = activeUserCount;
        });
        
        socket.on('user-left', (data) => {
            log('User left: ' + data.username + ' at ' + data.timestamp);
            activeUserCount = Math.max(0, activeUserCount - 1);
            activeUsersEl.textContent = activeUserCount;
        });
        
        socket.on('file-updated', (data) => {
            log('ðŸ”¥ FILE UPDATED: ' + JSON.stringify(data), 'success');
        });
        
        function testFileUpdate() {
            const testData = {
                fileId: fileId,
                action: 'update',
                rowIndex: 0,
                cellData: {
                    newValue: 'TEST UPDATE ' + Date.now(),
                    oldValue: 'OLD VALUE',
                    columnIndex: 0
                }
            };
            
            socket.emit('file-updated', testData);
            log('Sent file-updated event: ' + JSON.stringify(testData), 'info');
        }
    </script>
</body>
</html>